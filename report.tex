\documentclass[10pt,letterpaper]{article}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage[english]{babel}
\usepackage{breakurl}
\usepackage[superscript]{cite}
\usepackage{draftwatermark}
\usepackage{fancyhdr}
\usepackage{float}
\usepackage[margin=1in]{geometry}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage[utf8]{inputenc}
\usepackage{listings}
\usepackage{makeidx}
\usepackage{multicol}
\usepackage{nth}
% \usepackage[default,scale=1.0]{opensans} % CHANGED:
\usepackage{pgf-umlcd}
\usepackage{setspace}
\usepackage{siunitx}
\usepackage{svg}
\usepackage{subcaption}
\usepackage{tikz}
\usepackage{url}

% [PREAMBLE]
% Custom commands
\newcommand{\ts}{\textsubscript}
\newcommand{\bs}{\bigskip}

% !!! Global variables
\newcommand{\titletext}{Exploration of Design Patterns in Game Development}

% Change color of UML diagrams
\renewcommand{\umltextcolor}{black}
\renewcommand{\umldrawcolor}{black}
\renewcommand{\umlfillcolor}{white}

% New flags
\newif\iftwocolumns

% Set flags
% \twocolumnsfalse
\twocolumnstrue

% Double spacing
% \doublespacing

% Watermark
\SetWatermarkText{Draft}
\SetWatermarkScale{5}
\SetWatermarkColor[gray]{0.95}

% Use hyphans to break up urls
\def\UrlBreaks{\do\/\do-}

% Hyper ref setup
\hypersetup{
	colorlinks=true,
	citecolor=black,
	linkcolor=black,
	filecolor=black,
	% urlcolor=blue,
	urlcolor=black,
	pdftitle={APSC 310 Technical Report - Muchen He},
	bookmarks=true
}
\urlstyle{same}

% Page semantics
\pagestyle{fancy}

% Header
\fancyhead[L]{\MakeUppercase{APSC 310}}
\fancyhead[R]{Muchen He}
\fancyfoot{}
\fancyfoot[C]{\thepage}

% Page indent
\parindent 0ex

% Metadata
\author{Muchen He}
\title{APSC 310 Work Term Technical Report}

% Listings style
\lstdefinestyle{codestyle}{
	basicstyle=\footnotesize,
	frame=single,
	tabsize=4
}
\lstset{style=codestyle}

% [DOCUMENT]
\begin{document}

% [TITLE PAGE]
\begin{titlepage}
	\begin{center}
		\vspace*{2in}
		\line(1, 0){400}\\
		\Huge{\textbf{\titletext{}}}\\[0.2cm]
		\large{\textbf{Technical Work Term Report (Work Term 3)}}\\[1cm]
		\Large{\textbf{APSC 310}}\\[1cm]
		\includegraphics[width=1.4cm]{assets/ubc}\\
		\textbf{University of British Columbia}\\
		\line(1, 0){400}\\
		\vfill
		\Large{Muchen He}\\
		\large{Associate Developer, BioWare Edmonton}\\
		Student Number: 44638154\\

		\today \\
	\end{center}
\end{titlepage}

% [TOC]
\setcounter{secnumdepth}{3}
\tableofcontents
\thispagestyle{empty}
\clearpage

% [PREFACE]

% Set page numbering to roman for preface
\pagenumbering{roman}

% !!! Preface
\section*{Preface \& Foreword}
\addcontentsline{toc}{section}{Preface \& Foreword}

% Purpose
\subsection*{Purpose}
\addcontentsline{toc}{subsection}{Purpose}

The purpose of this report is to explore and observer different kinds of theoretical methods nad patterns and how they're used ot develop components that make up a game.\bs
\\
As well to consolidate my knowledge as a whole in the industry as design patterns are software development concepts and potentially applicable elsewhere in the tech industry.

% Background
\subsection*{Background}
\addcontentsline{toc}{subsection}{Background}

(Working at EA-Bioware)
(Associate Developer (Programmer) for game Anthem)
(Using modern game engine Frostbite)

% Scope
\subsection*{Scope of Coverage}
\addcontentsline{toc}{subsection}{Scope of Coverage}

(The scope of this report)(Covers many design patterns outlined in ``Gang of Four'')(Will not cover detailed breakdown, explaination, and specification of existing proprietary tech; i.e. extended code from the game or Frostbite engine)\bs
\\
The technical coverage cited in this report is limited because the co-op work term position is working in UI/UX. Thus I lack understanding in other areas of the game such as character handling, world rendering, etc. Many of the workflows I describe in this report may only apply to UI/UX development within this project.\bs
\\
As the scope of game development or software development extends wide in breadth, this report will not throughly cover topics of object oriented programming, development methodologies, specific syntax in a programming language, specific implementations of algorithms in a programming language, and psychology of UI/UX.

% (Other) Contributors
\subsection*{Contributors}
\addcontentsline{toc}{subsection}{Contributors}

(Tim Gibson - senior software lead, manager: contribution by supervising the report and giving advice) 
(Chris Johnson)

\newpage

% !!! [SUMMARY]
\section*{Summary}
\addcontentsline{toc}{section}{Summary}
\newpage

% [List of Figures/Tables]
% \thispagestyle{empty}
\listoffigures
\addcontentsline{toc}{section}{List of Figures}
\listoftables
\addcontentsline{toc}{section}{List of Tables}
\newpage

% Reset page counter
\pagenumbering{arabic}
\setcounter{page}{1}
\setcounter{section}{0}

% !!! [INTRODUCTION]
\iftwocolumns
\begin{multicols}{2}
\fi

% ??? [DISCUSSION]
\section{Introduction}

This enters the discussion portion of the report. We will analyze the current processes in game development for UI/UX at BioWare. Then look at some of the more theoretical, templated solutions known as design patterns in later sections and draw comparisons. We will also look into how the design patterns would be used in a general sense in game development (not specific to BioWare or Bioware's current project, Anthem).

\subsection{Game Development Overview}

% There are many parts to a video game. It can be grouped into: rendering, physics / simulation, AI, UI, sound / music. online, controls (input handling), online / networking. All tied together by the game engine.\\

% Having all the systems working together monolithically is bad, becuase it's difficult to maintain, prone to errors and bugs, and hard to collaborate as sub-systems are too tightly coupled.\\

% Talk about the video game industry -> video game development
% -> video game roles
A major portion of the video game market consists of AAA video games. These are titles with very high production value, large budget, and typically consists of a team of hundreds of developers. These developers consist of artists, scripters, programmers, managers, etc. Many of these roles are further grouped into sub-teams such as rendering, physics/simulation, AI, UI/UX, sound design, music production, networking, etc. Individual developers are specialized to work on one part of the game, with the exception of leads, managers, and other executives.

\subsubsection{Game Engine}
Developers will use a game engine so that many people can work on the project at once. The game engine is generally highly optimized for graphics rendering, physics simulation (such as collision detection), and object handling.\bs

The Frostbite engine is the game engine widely adoped at Electronic Arts (EA) studios. It was originally developed by Digital Illusions CE (DICE).\cite{frostbite}\cite{frostbite-wiki} As expected, the game engine is a piece of software, thus it is prone to software development problems that design patterns are ought to solve.

\subsection{Game Building}

Programmers make primitive entities such as an abstract UI widget, as well as the system that manages these entities.\bs
\\
The scripters and artists then use these entities in \textit{schematics} or \textit{blueprints}, which are used for visual scripting blocks of game content that contains logic and input/output together. Figure \ref{fig:unreal-blueprint} shows an example of what it looks like.\bs
\\
These schematics are in game levels, UI widgets, and prefabricated logic blocks (LogicPrefab). Thousands of these make up functionalities in a game, and are all handled by the game engine.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\textwidth]{assets/unreal-blueprint}
	\caption{Blueprint (schematics) for development in Unreal Engine\cite{unity-vs-unreal}}
	\label{fig:unreal-blueprint}
\end{figure}

\subsubsection{Role of Programmers}

At BioWare, most game programmers work with code (in C++ and C\#). Programmers are specialized to develop in-game entities, or tools for scripters, designers, and artists. Programmers also integrate systems together, such as making mouse inputs interact with hitzones widgets, which interacts with graphical widgest or animation timelines.\footnote{Animation timelines are timeline that describe how a particular object will animate. Example: a fade in.}

\subsection{Object Oriented Programming}
% TODO:

\subsection{Design Pattern}

Design patterns are reusable, general, abstract solutions to common problems in software developent.\cite{sm-designpatterns} Design patterns are meant to be used when there no problems actually exist -- doing so would cause excess undesired complexity.

\subsubsection{Antipatterns}
Software written without care are difficult to maintain, prone to bugs and errors, and hard to collaborate. Software written with these ``hacks'' are known as \textit{antipatterns}, where there is more negative consequences than the benefits of its solution. Antipatterns are counter parts to correctly implemented design patterns.\cite{sm-antipatterns}\bs
\\
Avoid antipatterns as much as possible. Exploring the negative effects of antipatterns is not part of the scope of this report.

\subsection{Gang of Four}

In software development, the phrase ``Gang of Four'' refers to the four authors of the Design Patterns book, Erich Gamma, Richard Helm, Ralph Johnson, and John Vlissides\cite{gof-wiki}. The book features the most common design patterns widely in use today.\bs
\\
The design patterns featured in the book outlines the classical design patterns. Thus, many patterns would not be applicable as more recent revisions of programming languages (Python, c++11, etc.). This is because design patterns are inheritantly solutions / workarounds to limitations of the programming language. As there are more improvement in the usability of the language, certain design patterns (such as the \textit{template} pattern) are implemented less as it's less complex, less error prone, and easier to use the existing features built-in to a language.


\section{Creational Design Patterns}

Creational design patterns involves with object creation.\cite{sm-creationaldp} This is especially useful in game development, such as when we need to create many trees or bushes in a level of a game. These patterns become more useful when the objects we're trying to create have relationships, such as \textit{inheritance}, to other objects.

\subsection{Builder}

In object oriented programming (OOP), the construction of a class instance takes parameters. It is possible that we need a lot of parameters to satisfy more variants of the class. This introduces the telescoping constructor antipattern\cite{telescopingconstructor}, where there are numerous variations of constructor methods all delegate to the default constructor. This chains the different constructors together like an upside-down cake, or a telescope shape.\bs
\\
The code is hard to maintain and difficult to use. When creating a new instance (invoking the constructor), it's hard to tell what the actual paramters are if they have the same type. Using default parameters is useful but makes code less usable as it changes the parameter ordering.\bs
\\
The \textbf{builder pattern} encapsulates the parameters into a single structure. The structure itself is then passed into the constructor method, where we can access the data inside the structure again. The members of the structure can be accessed and modified by name, thereby eliminating the ambiguity of telescoping constructor.\bs
\\
This is useful in games. For example, a customizable character has many attributes that can be filled in (Figure \ref{fig:playercharacter-1}). Realize that as we increase the number of attributes, we also need more parameters in the constructor to populate the attributes.

\begin{figure}[H]
	\centering

	\begin{tikzpicture}
		\begin{class}{PlayerCharacter}{0,0}
			\attribute{name: string}
			\attribute{age: int}
			\attribute{height: float}
			\attribute{weight: float}
			\operation{PlayerCharacter(string name, int age, float height, float weight)}
		\end{class}
	\end{tikzpicture}

	\caption{PlayerCharacter class with various desired parameters}
	\label{fig:playercharacter-1}
\end{figure}

Using the builder pattern, we create a encapsulated structure that would contain all the parameters in figure \ref{fig:playercharacter-builder} and then default all of the struct internal variables to some default value. We then have the flexibility to fill in whichever attribute we want to change by modifying the struct's members (\texttt{struct PlayerCharacterBuilder builder; builder.age = 25;}). Optional logic could be added to the builder as well.

\begin{figure}[H]
	\centering

	\begin{tikzpicture}
		\begin{class}{struct PlayerCharacterBuilder}{0,0}
			\attribute{name: string = "Alex"}
			\attribute{age: int = 20}
			\attribute{height: float = 175.0}
			\attribute{weight: float = 180.0}
		\end{class}
	\end{tikzpicture}

	\caption{PlayerCharacterBuilder struct}
	\label{fig:playercharacter-builder}
\end{figure}

Now, the PlayerCharacter class constructor only uses a single parameter of the builder type reference (figure \ref{fig:playercharacter-2}). The constructor then reads all the values in the struct, and assign them to the corresponding member variables.

\begin{figure}[H]
	\centering

	\begin{tikzpicture}
		\begin{class}{PlayerCharacter}{0,0}
			\attribute{name: string}
			\attribute{age: int}
			\attribute{height: float}
			\attribute{weight: float}
			\operation{PlayerCharacter(struct PlayerCharacterBuilder \&builder)}
		\end{class}
	\end{tikzpicture}

	\caption{PlayerCharacter class with various desired parameters}
	\label{fig:playercharacter-2}
\end{figure}

Of course, this pattern is applicable widely in game development, from in game objects that have visual variations, to online player save files, and even the build pipelines used during development to build game assets.\bs
\\
A sample code for this pattern is available in section \ref{code:builder}.

\subsection{Factories}

Factory is a quintessential creational design pattern because it governs the creation of different types of objects at a scalable level. For programming games, memory allocation and management is tricky, therefore it is helpful to not expose that kind of control to the client code.\bs
\\
The three main factories patterns we will explore is \textit{Simple Factory}, \textit{Abstract Factory}, and \textit{Factory Method}. However, because factory method pattern is very similar to abstract factory\cite{sm-factory-method} in the context we care about, we will only explore abstract factory. The general pattern in all these different factory patterns is that the keyword \texttt{new} in C++ is harmful. And that the factory should abstract away the specific steps to instantiation.\bs
\\
\textbf{Simple Factory}\\
As the name suggests, the \textit{simple factory} is as simple as a factory could get, the simple factory generates an instance for the client but does not expose any instantiation logic.\cite{simple-factory}\bs
\\
A real life analogy would be purchasing a burger: the client requests one burger, and the restaurant makes the burger and give it to the client. Without the factory design pattern, the client would need to gather all the ingredients of the burger and make it themselves, which is repetitive and unproductive.\bs
\\
(Simple factory in game developement ehhhhh).\bs
\\
A sample code for this pattern is available in section \ref{code:simple-factory}.\bs
\\

\textbf{Abstract Factory}\\
Abstract factories are useful in cases where we need to instantiate abstract objects, but we do not know the specific concrete object yet\cite{sm-abstract-factory}. This pattern is prevalent in cross-platform UI programming where the identical elements have similar characteristics, but behave slightly differently under the hood.\bs
\\
For instance, suppose we have a game that runs on Xbox, PlayStation, and PC, and in it we have a UI widget to enter the player name. The expected behavior would be to open the first-party on screen keyboard for the two consoles, and do nothing for PC (as keyboard is physical). In this case, to make the code more maintainable, we would not program it with two or more variants just to work with different controls.\bs
\\
A similar example is provided in the sample code in section \ref{code:abstract-factory}\cite{sm-abstract-factory-example}.\bs
\\
Of course, the abstract factory could be generalized to various mechanisms within a game from game objects to player characters.\bs
\\

\subsection{Object Pool}

An analogy in real life would be a library of books. When a client wants to access some information, instead of writing a new book to the client to use every time, which is expensive, we check if the book already exists in the library. Then we could lend the book to the client. When the client is finished, they return the book for other clients to checkout.\bs
\\
The object pool is a creational design pattern that caches objects for re-use. An object pool can let clients check-out objects from the pool. If a requested object do not exist, the pool can create a new object; although expensive, it only occurs once. Finally, using object pool better organizes object life time of the objects in the pool. Thus we can free memory by clean up unused objects periodically (often known as \textit{garbage collection}).\bs
\\
% NOTE: textures cannot be used as example as they are more like flyweights
% An example of this used in games are cached textures: 

% TODO:
An example of the object pool design pattern would be

\subsection{Prototype}

The \textit{prototype} design pattern helps when we need to create an object that is similar to an existing one, but instantiating a new instance is relatively expensive.\bs
\\
For instance, suppose we have a procedrally generated 3D model of a rock and we want to clone this model all over the place $N$ times.\bs
\\
We could just generate $N$ rocks like how we generated the first one using the same random seed.\footnote{Procedurally generation relies on pseudo-random or noise, which are based off of a seed.} The problem is for every clone of the rock, there are computational overheads that hinders efficiency: such as re-computing the normal vectors from all the faces of the polygon, or recalculating teh UV coordinates for the texture.\bs
\\
Using the prototype design pattern, we implement a clone method to the rock object that copies all its data to a new instance, thereby avoiding the re-computation overheads.

\subsection{Singleton}

In a way, they're just glorified global variable.

In game development, singletons are often reserved for system managers. i.e. a single manager class that overlooks and orchestrates UI system.

Singleton patterns are also used in expensive assets such as levels and personalization libraries (customizations) where we load them into memory during loading screen initially. Then their instance can be accessed via a static function call.

\section{Behaviour Design Patterns}

\subsection{Chain of Responsibility}

(InputHandlers and InputDispatchers) in Frostbite engine. A series of input handlers are chained together. Each input handler may hold reference to other input handlers.
\bs
When an input, such as mouse, keyboard, or controller action occurs. The calls traverses down the chain of input handlers until one of the input handler entities "consumes" it, which ends the chain.
\bs

Another chain of command pattern observed in the Forstbite engine editor, is handling mouse press when there are multiple \textit{hitzones}\footnote{Hitzones are interactive areas for mouse that reports data and events such as mouse position, if mouse is hover, mouse button presses and releases} overlapped (figure \ref{fig:chainofcommand-mousezones}). Any press or hovering event will be handled by the top-most hitzone entity first. If the handler does not consume the input event, the event will naturally "flow" down to the next level.
\bs

\begin{figure}[H]
	\centering
	\includegraphics[width=0.3\textwidth]{assets/chainofcommand_mousezones}
	\caption{Mouse interacting with overlapping mouse hitzones}
	\label{fig:chainofcommand-mousezones}
\end{figure}

\subsection{Command}

Decouples action request and action handlers. The callee who makes the request makes no assumptions about the class the receives the command. Effectively decoupling them.
\bs
This opens up more flexibility in mapping a requets to a handler. An example is remappable input handling. Instead of listening for a key press, then calling a specific function that the key press corresponds to. It invokes a command object that holds a reference to the \textit{real object} so that the handler can be called.
\bs
In between we could do more things. For instance, keep track of how many times the action has requested.
\bs
Command pattern also opens up for redo/undo operations.

\subsection{Mediator}\label{ssection:mediator}

Mediator acts as a middle-man between communicating objects and decouples them\cite{sm-mediator}.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.3\textwidth]{assets/mediator_before}
	\caption{Objects communicating without using mediator pattern}
	\label{fig:mediator-before}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.3\textwidth]{assets/mediator_after}
	\caption{Objects communicating using mediator pattern}
	\label{fig:mediator-after}
\end{figure}

As seen in figure \ref{fig:mediator-before}, complexity of interactions between objects become exponentially large as the software grows.
\bs
Such problem occurs often in UI: An example would be when a input signal is mapped to multiple elements. In particular, say we have a button to open up the game menu. Then at the same time there are a few systems we need to talk to during this. First, we need to tell the game to lock all inputs to the character in the world, so that when we're navigating the menu, we don't move the character around. We want to enable mouse cursor (and hide it during game play). We might want to pause the game so that enemies don't attack in the background while we have the menu open. We might want to optimize performance by turning off rendering of the world when we're in the menu, since we might not able to see it anyway.
\bs
Without using a mediator, the activated event from the button would need to invoke methods in all these different systems. This \textit{antipattern} breaks abstraction, tightly decouples all these systems together which makes it prone to error and crashes, and makes the code highly unmaintainable.
\bs
Instead, we use pattern as depicted in figure \ref{fig:mediator-after}. The button event should communicate with a middle-man that sets a state. The various systems that would be affected does not know anything about the button, or anything that interacts with the mediator. It merely gets the state stored in the mediator, and performs corresponding action.
\bs

In Frostbite, a similar mechanism is called a \textit{SharedLock}. 

\subsection{Memento}

\subsection{Observer}

\subsection{Visitor}

\section{Structural Design Patterns}

\subsection{Adapter}

A middle layer that transforms the interface of a desired object (usually provided by libraries) to work with client.

\subsubsection{Difference Between Adapter and Mediator}

Different from \textit{mediators} (section \ref{ssection:mediator}), as mediator manages the communication between two classes, essentially decouples the interaction of the two. Whereas adapter simply translates.
\bs
Consider a real life analogy, where two people who speak different languages are fighting. A mediator would be a lawyer such that the two people don't talk to each other directly. An adapter would be a translator so that the two can communicate more directly.
\bs
Thus, adapter is structural. And Mediator is behavioral.

\subsection{Bridge}

\subsection{Composite}
Useful in architectures such as component-entity-systems model which centers around the idea of ``\textit{composition over inheritance}" (section \ref{ssection:ecs}).


\subsection{Decorator}

\subsection{Facade}

\subsection{Flyweight}

\subsection{Proxy}

Smart pointers, etc.

\section{Architectural Patterns}

\subsection{Entity-Component-System}\label{ssection:ecs}

Used in physic engines, and when there are a lot of things to handle.

In UI Systems as there are also lots of things to handle. UI widgets do not necessary need to interact with other UI widgets. So using this architecture enables performance optimizations.

Update calls can be queued for all objects at once. Update states can be cached. Cached data are much faster.

\subsubsection{Composition over Inheritance}

OOP principle that makes inheritance based on composition / behavior rather than inheritance from parent.
\bs
Consider code in section \ref{code:coi-component}, rather than defining class by their ``likeness'', we define it by its function.
\bs
Then in 

\subsection{Model-View-Controller}

Mostly used in UI development. 

% !!! [CONCLUSION]
\section{Conclusions}

\iftwocolumns
\end{multicols}
\fi

% !!! [BIBLIOGRAPHY]
\clearpage
\addcontentsline{toc}{section}{References}
% \bibliographystyle{apalike}
\bibliographystyle{ieeetr}
\bibliography{references}

% !!! [APPENDIX]
\clearpage
\appendix
\section{Sample Code}

\subsection{Builder}
\lstinputlisting[language=C++, firstline=5]{code/Builder.hpp}\label{code:builder}

\subsection{Simple Factory}
\lstinputlisting[language=C++, firstline=3, lastline=59]{code/Factories.hpp}\label{code:simple-factory}

\subsubsection{Not using factory}
\lstinputlisting[language=C++, firstline=62, lastline=71]{code/Factories.hpp}

\subsubsection{Using factory}
\lstinputlisting[language=C++, firstline=73, lastline=76]{code/Factories.hpp}

\subsection{Abstract Factory}
\lstinputlisting[language=C++, firstline=79, lastline=116]{code/Factories.hpp}\label{code:abstract-factory}

\subsection{Composition over Inheritance}

\subsubsection{Components}
\lstinputlisting[language=C++, lastline=26]{code/CompositionOverInheritance_1.hpp}\label{code:coi-component}

\subsubsection{Usage}
\lstinputlisting[language=C++, firstline=28]{code/CompositionOverInheritance_1.hpp}\label{code:coi-usage}

% End of document
\end{document}